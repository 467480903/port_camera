<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>摄像头控制面板（jQuery）</title>
  <style>
    html,body{height:100%;margin:0;font-family:Arial,\'Noto Sans SC\',sans-serif}
    .container{display:flex;height:100vh;gap:12px;padding:12px;box-sizing:border-box}
    .left{width:360px;min-width:260px;background:#f7f7f7;border-radius:8px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.06);display:flex;flex-direction:column;align-items:flex-start}
    .right{flex:1;background:#111;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:8px}
    .control-row{display:flex;align-items:center;gap:8px;margin-bottom:12px;width:100%}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button:active{transform:translateY(1px)}
    .label{min-width:140px}
    .big-value{font-weight:700;font-size:20px}
    .img-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    #mjpgStream{max-width:100%;max-height:100%;border-radius:6px;border:1px solid #333}
    .title{font-size:18px;margin-bottom:8px}
    .small{font-size:12px;color:#666}
    .status{margin-top:auto;font-size:12px;color:#444}
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <div class="title">摄像头控制</div>

      <div class="control-row">
        <button id="zoomOut">缩小</button>
        <div class="label">放大比例： <span id="zoomVal" class="big-value">-</span></div>
        <button id="zoomIn">放大</button>
      </div>

      <div class="control-row">
        <button id="focusMinus">聚焦-</button>
        <div class="label">聚焦值： <span id="focusVal" class="big-value">-</span></div>
        <button id="focusPlus">聚焦+</button>
      </div>

      <div class="control-row">
        <div class="label">激光测距值： <span id="laserVal" class="big-value">-</span></div>
      </div>

      <div style="height:12px"></div>
      <div class="small">说明：</div>
      <ul class="small">
        <li>三个数值每秒从 <code>http://localhost:1881/zoom</code>、<code>/focus</code>、<code>/laser</code> 轮询获取。</li>
        <li>按下放大/缩小/聚焦+/聚焦- 会向 <code>/setzoom</code> 或 <code>/setfocus</code> 发送带参数 <code>value</code> 的 GET 请求。</li>
        <li>如果你的摄像头 MJPG 流地址不同，请在页面顶部的 <code>STREAM_URL</code> 常量中修改。</li>
      </ul>

      <div class="status" id="status">状态：初始化中...</div>
    </div>

    <div class="right">
      <div class="img-wrap">
        <!-- 默认 MJPG 流地址：请根据你的摄像头修改 -->
        <img id="mjpgStream" src="http://localhost:8080/?action=stream" alt="MJPG Stream" />
      </div>
    </div>
  </div>

  <!-- jQuery from CDN -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // 配置（必要时修改）
    const STREAM_URL = 'http://192.168.1.64/ISAPI/Streaming/channels/102/httppreview?token=f5dc6539ce8c055748b3d21258a70a4e'; // 更换为你的 MJPG 地址
    const POLL_BASE = 'http://localhost:1881';
    const POLL_INTERVAL_MS = 1000; // 1 秒
    const STEP = 10; // 按键每次改变的步长（可根据需要调整）

    $(function(){
      // 将 img src 设置为 STREAM_URL（方便用户只需修改顶部变量）
      $('#mjpgStream').attr('src', STREAM_URL);

      let currentZoom = null;
      let currentFocus = null;

      // 更新状态栏
      function setStatus(text){ $('#status').text('状态：' + text); }

      // 从后端获取值并更新页面
      function pollValues(){
        // Zoom
        $.get(POLL_BASE + '/zoom').done(function(data){
          // 假设返回的是纯数字或 JSON 包含 value 字段
          let val = parseNumericResponse(data);
          if(val !== null){ currentZoom = val; $('#zoomVal').text(val); }
        }).fail(function(){ /* ignore errors for single poll */ });

        // Focus
        $.get(POLL_BASE + '/focus').done(function(data){
          let val = parseNumericResponse(data);
          if(val !== null){ currentFocus = val; $('#focusVal').text(val); }
        }).fail(function(){ });

        // Laser
        $.get(POLL_BASE + '/laser').done(function(data){
          let val = parseNumericResponse(data);
          if(val !== null){ $('#laserVal').text(val); }
        }).fail(function(){ });
      }

      // 尝试从多种响应格式中解析数字（纯数字、{"value":123}、"{\"value\":123}")
      function parseNumericResponse(data){
        try{
          if(typeof data === 'number') return data;
          if(typeof data === 'string'){
            // 尝试直接转数字
            let trimmed = data.trim();
            if(trimmed === '') return null;
            // 如果像是 JSON，尝试解析
            if((trimmed[0] === '{' || trimmed[0] === '[')){
              let j = JSON.parse(trimmed);
              if(j && (j.value !== undefined)) return Number(j.value);
              // 如果是对象且含有数字字段，尝试找到第一个数字
              for(let k in j){ if(typeof j[k] === 'number') return j[k]; }
            }
            // 最后尝试直接 parseFloat
            let n = parseFloat(trimmed);
            return isNaN(n) ? null : n;
          }
        }catch(e){ return null; }
        return null;
      }

      // 发送 setzoom 或 setfocus 请求
      function sendSet(endpoint, value){
        $.get(POLL_BASE + '/' + endpoint, { value: value }).done(function(){
          setStatus(endpoint + ' 已发送: ' + value);
          // 立即刷新一次数据（试图同步 UI）
          pollValues();
        }).fail(function(){ setStatus(endpoint + ' 发送失败'); });
      }

      // 按钮绑定
      $('#zoomIn').on('click', function(){
        let newVal = (currentZoom === null) ? 100 : Number(currentZoom) + STEP;
        sendSet('setzoom', newVal);
      });
      $('#zoomOut').on('click', function(){
        let newVal = (currentZoom === null) ? 0 : Number(currentZoom) - STEP;
        if(newVal < 0) newVal = 0;
        sendSet('setzoom', newVal);
      });

      $('#focusPlus').on('click', function(){
        let newVal = (currentFocus === null) ? 100 : Number(currentFocus) + STEP;
        sendSet('setfocus', newVal);
      });
      $('#focusMinus').on('click', function(){
        let newVal = (currentFocus === null) ? 0 : Number(currentFocus) - STEP;
        if(newVal < 0) newVal = 0;
        sendSet('setfocus', newVal);
      });

      // 启动轮询
      pollValues();
      setInterval(pollValues, POLL_INTERVAL_MS);

      setStatus('运行中，轮询间隔 ' + POLL_INTERVAL_MS + ' ms');

    });
  </script>
</body>
</html>
